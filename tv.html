<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Capture The Flag - Multiplayer (Firebase)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  :root{--bg:#071228;--panel:#0e1b34;--red:#ff4b5c;--blue:#3fb1ff;--text:#dff3ff}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;min-height:100vh}
  .top{width:100%;max-width:980px;padding:10px;display:flex;gap:8px;align-items:center;justify-content:center}
  input,button{padding:8px 12px;border-radius:8px;border:none}
  button{cursor:pointer}
  canvas{background:#071a2a;border-radius:10px;border:2px solid #12314b}
  .hud{margin-top:8px;display:flex;gap:12px;align-items:center}
  .teamBadge{padding:6px 10px;border-radius:999px;font-weight:700}
  .board{margin-top:10px;background:var(--panel);padding:10px;border-radius:8px;width:520px}
  .controls{margin-top:8px;font-size:13px;color:#a8d6ff}
  .msg{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.6);padding:12px 16px;border-radius:10px;display:none}
</style>
</head>
<body>
  <div class="top">
    <button onclick="createRoom()">Criar sala</button>
    <input id="roomCode" placeholder="Código 4 dígitos" maxlength="4" />
    <button onclick="joinRoom()">Entrar</button>
    <button onclick="leaveRoom()">Sair</button>
    <div style="margin-left:10px">Seu ID: <span id="pid"></span></div>
  </div>

  <canvas id="cv" width="720" height="440"></canvas>
  <div class="hud">
    <div id="teamBadge" class="teamBadge">Time: -</div>
    <div id="scoreBoard">Placar — Red: 0 | Blue: 0</div>
    <div style="margin-left:10px">Controles: WASD/Setas mover • Espaço tag • Mouse tocar para mirar</div>
  </div>

  <div class="board" id="board">Placar detalhado</div>
  <div class="msg" id="centerMsg">Mensagem</div>

<script>
// -------- Firebase config (substitua se quiser) --------
const firebaseConfig = {
  apiKey: "AIzaSyBJS1ilaSPaRe1m3NUE9blpa7MGiRchvvo",
  authDomain: "youfriends2025.firebaseapp.com",
  databaseURL: "https://youfriends2025-default-rtdb.firebaseio.com",
  projectId: "youfriends2025",
  storageBucket: "youfriends2025.firebasestorage.app",
  messagingSenderId: "1025903866437",
  appId: "1:1025903866437:web:49401c0e8edf59dd63292c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// -------- Estado local --------
const cv = document.getElementById('cv');
const cx = cv.getContext('2d');
const teamBadge = document.getElementById('teamBadge');
const scoreBoard = document.getElementById('scoreBoard');
const board = document.getElementById('board');
const centerMsg = document.getElementById('centerMsg');

const clientId = 'u_' + Math.random().toString(36).slice(2,8);
document.getElementById('pid').innerText = clientId;
let roomId = '';
let connected = false;

const ARENA = {w: cv.width, h: cv.height};

// Bases e flags
const baseRed = {x:80,y:ARENA.h/2};
const baseBlue = {x:ARENA.w-80,y:ARENA.h/2};

// player local
let me = {x: baseRed.x+40, y: baseRed.y, r:12, color:'#ff7b86', team:'red', carrying:false, alive:true, respawnTimer:0, score:0};
let others = {};
let flags = { red: {atBase:true, carriedBy:null, x:baseRed.x, y:baseRed.y}, blue:{atBase:true, carriedBy:null, x:baseBlue.x, y:baseBlue.y} };
let scores = { red:0, blue:0 };

// walls (simple obstacles)
const walls=[{x:240,y:40,w:20,h:120},{x:460,y:280,w:20,h:120},{x:300,y:200,w:120,h:20}];

// -------- Utils --------
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function dist(a,b,c,d){ return Math.hypot(a-c,b-d); }
function showMsg(t){ centerMsg.innerText=t; centerMsg.style.display='block'; setTimeout(()=>centerMsg.style.display='none',2000); }

// -------- Database helpers --------
function writeMe(){ if(!roomId) return; db.ref(`ctf/${roomId}/players/${clientId}`).set({x:Math.round(me.x),y:Math.round(me.y),team:me.team,carrying:me.carrying||false,alive:me.alive,score:me.score,t:Date.now()}); db.ref(`ctf/${roomId}/players/${clientId}`).onDisconnect().remove(); }

function writeFlag(flagKey, payload){ if(!roomId) return; db.ref(`ctf/${roomId}/flags/${flagKey}`).set(payload); }

function writeScore(){ if(!roomId) return; db.ref(`ctf/${roomId}/score`).set(scores); }

function createRoom(){ const code = (Math.floor(1000+Math.random()*9000)).toString(); roomId = code; db.ref(`ctf/${roomId}`).set({created:Date.now()}).then(()=>{ document.getElementById('roomCode').value=code; joinRoom(); }); }

function joinRoom(){ const code = (document.getElementById('roomCode').value||'').trim(); if(code.length!==4) return alert('Código inválido'); roomId = code; connected=true; setupListeners(); assignTeamAndSpawn(); }

function leaveRoom(){ if(!roomId) return; connected=false; teardownListeners(); db.ref(`ctf/${roomId}/players/${clientId}`).remove(); roomId=''; showMsg('Saiu da sala'); }

let playersOn=null, flagsOn=null, scoreOn=null;
function setupListeners(){ teardownListeners(); playersOn = db.ref(`ctf/${roomId}/players`).on('value',snap=>{ const obj = snap.val()||{}; others={}; Object.keys(obj).forEach(id=>{ if(id!==clientId) others[id]=obj[id]; }); renderBoard(obj); }); flagsOn = db.ref(`ctf/${roomId}/flags`).on('value',snap=>{ const obj = snap.val()||{}; flags.red = obj.red || flags.red; flags.blue = obj.blue || flags.blue; }); scoreOn = db.ref(`ctf/${roomId}/score`).on('value',snap=>{ const s = snap.val(); if(s) scores=s; });
  // ensure flags exist
  db.ref(`ctf/${roomId}/flags`).once('value').then(s=>{ if(!s.exists()){ writeFlag('red',flags.red); writeFlag('blue',flags.blue); writeScore(); } });
}
function teardownListeners(){ try{ db.ref(`ctf/${roomId}/players`).off('value'); db.ref(`ctf/${roomId}/flags`).off('value'); db.ref(`ctf/${roomId}/score`).off('value'); }catch(e){} }

// -------- Team assignment & spawn --------
function assignTeamAndSpawn(){ db.ref(`ctf/${roomId}/players`).once('value').then(snap=>{ const obj = snap.val()||{}; // balance teams
    let reds=0, blues=0; Object.keys(obj).forEach(id=>{ if(obj[id].team==='red') reds++; if(obj[id].team==='blue') blues++; });
    me.team = (blues<reds)?'blue':'red'; me.color = me.team==='red' ? '#ff7b86' : '#73d0ff';
    const base = me.team==='red'? baseRed : baseBlue; me.x = base.x + (me.team==='red'?40:-40); me.y = base.y; me.carrying=false; me.alive=true; me.respawnTimer=0; me.score=0; teamBadge.innerText = `Time: ${me.team.toUpperCase()}`; teamBadge.style.background = me.team==='red'? '#3b0f12' : '#052534'; teamBadge.style.color = me.team==='red'? '#ffb6bf' : '#cfefff'; writeMe(); }); }

// -------- Gameplay logic --------
let keys = {};
document.addEventListener('keydown',e=>{ keys[e.key.toLowerCase()] = true; if(e.code==='Space') attemptTag(); });
document.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()] = false; });
cv.addEventListener('mousedown',e=>{ attemptTag(); });

function attemptTag(){ if(!me.alive) return; // tag players nearby from opposite team
  // tagging range
  const range = 20;
  // check others from DB (we have local copy in others)
  for(const id in others){ const p = others[id]; if(p.team && p.team!==me.team && p.alive){ const d = dist(me.x,me.y,p.x,p.y); if(d<=range){ // hit
        // reduce opponent: simple approach — set them dead in DB; they will respawn
        db.ref(`ctf/${roomId}/players/${id}`).update({alive:false});
        // if opponent carried flag, drop it
        if(flags.red.carriedBy===id) { flags.red = {atBase:false,carriedBy:null,x:p.x,y:p.y}; writeFlag('red',flags.red); }
        if(flags.blue.carriedBy===id) { flags.blue = {atBase:false,carriedBy:null,x:p.x,y:p.y}; writeFlag('blue',flags.blue); }
        // optionally award nothing, attacker stays alive
      }
  }} }

function updateGame(){ if(!connected) return; // movement
  if(me.alive){ let vx=0, vy=0; if(keys['w']||keys['arrowup']) vy-=1; if(keys['s']||keys['arrowdown']) vy+=1; if(keys['a']||keys['arrowleft']) vx-=1; if(keys['d']||keys['arrowright']) vx+=1; const mag = Math.hypot(vx,vy)||1; vx/=mag; vy/=mag; const speed = 2.2; let nx = me.x + vx*speed; let ny = me.y + vy*speed; nx = clamp(nx, 12, ARENA.w-12); ny = clamp(ny, 12, ARENA.h-12);
    // wall collisions
    const hits = walls.some(w=> circleRect(me.x,me.y,me.r, w.x,w.y,w.w,w.h));
    const willHit = walls.some(w=> circleRect(nx,ny,me.r, w.x,w.y,w.w,w.h));
    if(!willHit){ me.x = nx; me.y = ny; }

    // picking up flags
    // if near enemy flag and flag is atBase or dropped, pick up
    const enemyFlagKey = me.team==='red' ? 'blue' : 'red';
    const enemyFlag = flags[enemyFlagKey];
    if(enemyFlag){ const d = dist(me.x,me.y, enemyFlag.x, enemyFlag.y); if(d<20 && !enemyFlag.carriedBy){ // pick up
        enemyFlag.carriedBy = clientId; enemyFlag.atBase=false; writeFlag(enemyFlagKey, enemyFlag); me.carrying = true; writeMe(); showMsg('Você pegou a bandeira inimiga!'); }
    }

    // score: if carrying enemy flag and reaches own base
    const base = me.team==='red' ? baseRed : baseBlue;
    if(me.carrying){ const d = dist(me.x,me.y, base.x, base.y); if(d<24){ // score!
        // increment team score, reset enemy flag to base
        const enemy = me.team==='red' ? 'blue' : 'red'; scores[me.team] = (scores[me.team]||0)+1; writeScore(); flags[enemy] = {atBase:true,carriedBy:null,x: (enemy==='red'? baseRed.x: baseBlue.x), y:(enemy==='red'? baseRed.y: baseBlue.y)}; writeFlag(enemy, flags[enemy]); me.carrying=false; me.score++; writeMe(); showMsg('PONTO!'); }
    }
  }

  // if dead, handle respawn timer locally
  if(!me.alive){ me.respawnTimer = (me.respawnTimer||0)+1; if(me.respawnTimer>90){ // ~1.5s at 60fps
      // respawn at team base
      const base = me.team==='red'? baseRed: baseBlue; me.x = base.x + (me.team==='red'?40:-40); me.y = base.y; me.alive=true; me.respawnTimer=0; me.carrying=false; writeMe(); showMsg('Respawn'); }
  }

  // if carrying flag but got killed (server side) — ensure flag dropped on DB (we will check flags state)
  if(me.carrying && !me.alive){ const enemy = me.team==='red'? 'blue':'red'; flags[enemy] = {atBase:false,carriedBy:null,x:me.x, y:me.y}; writeFlag(enemy, flags[enemy]); me.carrying=false; }

  // update visuals scoreboard
  scoreBoard.innerText = `Placar — Red: ${scores.red||0} | Blue: ${scores.blue||0}`;
  writeMe();
}

function circleRect(cx,cy,r, rx,ry,rw,rh){ const nx = clamp(cx,rx,rx+rw); const ny = clamp(cy,ry,ry+rh); const dx = cx-nx; const dy = cy-ny; return (dx*dx+dy*dy) <= r*r; }

// -------- Render --------
function render(){ cx.clearRect(0,0,ARENA.w,ARENA.h);
  // floor
  cx.fillStyle='#042438'; cx.fillRect(0,0,ARENA.w,ARENA.h);
  // bases
  cx.fillStyle='#33060a'; cx.beginPath(); cx.arc(baseRed.x, baseRed.y, 36,0,Math.PI*2); cx.fill(); cx.fillStyle= '#06273a'; cx.beginPath(); cx.arc(baseBlue.x, baseBlue.y, 36,0,Math.PI*2); cx.fill();
  // flags
  // red flag
  drawFlag(flags.red, 'red'); drawFlag(flags.blue,'blue');
  // walls
  cx.fillStyle='#123149'; walls.forEach(w=> cx.fillRect(w.x,w.y,w.w,w.h));
  // other players
  for(const id in others){ const p = others[id]; drawPlayer(p.x,p.y, p.team==='red'?'#ff8b95':'#8fd8ff', id); }
  // me
  drawPlayer(me.x,me.y, me.color, 'Você' + (me.carrying? ' (carregando)':''));
  // board update
  renderBoardSimple();
}

function drawFlag(flagObj, key){ if(!flagObj) return; const isRed = key==='red'; const fx = flagObj.x; const fy = flagObj.y; cx.save(); cx.translate(fx,fy); cx.fillStyle = isRed? '#ff4b5c':'#3fb1ff'; cx.fillRect(-6,-14,12,20); cx.beginPath(); cx.moveTo(6,-14); cx.lineTo(22,-6); cx.lineTo(6,2); cx.closePath(); cx.fill(); cx.restore();
}

function drawPlayer(x,y,color,label){ cx.fillStyle=color; cx.beginPath(); cx.arc(x,y,12,0,Math.PI*2); cx.fill(); cx.fillStyle='#001222'; cx.beginPath(); cx.arc(x+5,y-3,3,0,Math.PI*2); cx.fill(); cx.fillStyle='#dff3ff'; cx.font='11px system-ui'; cx.textAlign='center'; cx.fillText(label, x, y-18); }

function renderBoardSimple(){ // detailed scoreboard
  const lines = [];
  // me
  lines.push(`<div style="display:flex;justify-content:space-between"><strong>Você (${me.team})</strong><span>${me.score}</span></div>`);
  for(const id in others){ const p = others[id]; lines.push(`<div style="display:flex;justify-content:space-between"><span>${id.slice(0,6)} (${p.team||'?'})</span><span>${p.score||0}</span></div>`); }
  board.innerHTML = lines.join(''); }

// -------- Loop --------
function gameLoop(){ updateGame(); render(); requestAnimationFrame(gameLoop); }
requestAnimationFrame(gameLoop);

// -------- Helpers to interact with flags/DB from listeners --------
// ensure when DB flags change and a carriedBy is set to a player id that equals me, update me.carrying

// -------- Endpoints for debugging/test --------
window.createRoom = createRoom; window.joinRoom = joinRoom; window.leaveRoom = leaveRoom;

// -------- Explanation: listeners handle DB updates for players, flags, score --------
// We'll keep this simple: players are authoritative from clients; when tagging we update opponent alive false in DB;
// flags state is written to DB when picked/dropped/scored. This is a prototype - for production a server authoritative
// approach and security rules are necessary.
</script>
</body>
</html>
