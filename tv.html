<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pac-Battle Multiplayer (Firebase)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- Firebase compat libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
/* --- estilos iguais ao teu --- */
body { margin:0; background:black; color:white; font-family:Arial,sans-serif; display:flex; flex-direction:column; align-items:center; min-height:100vh; touch-action:manipulation; }
.header{width:100%;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:center;}
.header input,.header button{padding:8px;border-radius:6px;border:none;font-size:14px;}
.header button{background:#e50914;color:white;font-weight:bold;cursor:pointer;}
#gameCanvas{background:#111;border:2px solid #666;margin-top:10px;}
.controls{position:fixed;bottom:10px;width:100%;display:flex;justify-content:space-between;padding:0 20px;pointer-events:none;}
.dpad,.actions{pointer-events:auto;}
.dpad{display:grid;grid-template-columns:60px 60px 60px;grid-template-rows:60px 60px 60px;gap:10px;}
.btn{background:#222;border:2px solid #666;border-radius:10px;display:flex;justify-content:center;align-items:center;font-size:22px;color:white;user-select:none;touch-action:manipulation;}
.btn:active{background:#555}
.actions{display:grid;grid-template-columns:80px 80px;grid-template-rows:80px 80px;gap:15px;}
.action-btn{width:70px;height:70px;border-radius:50%;display:flex;justify-content:center;align-items:center;background:#444;color:white;font-size:26px;touch-action:manipulation;}
.action-btn.red{background:#c62828}.action-btn.blue{background:#1565c0}
.hud{position:absolute;top:6px;left:8px;color:white;font-weight:bold;}
.roomLabel{position:absolute;top:6px;right:8px;color:#ddd;font-size:14px;}
.footer{margin-top:12px;color:#aaa;font-size:13px;}
</style>
</head>
<body>
  <div class="header">
    <button onclick="criarSala()">Criar Sala</button>
    <input id="codigoSala" placeholder="C√≥digo da sala (4 d√≠gitos)" maxlength="4" style="width:110px;">
    <button onclick="entrarSala()">Entrar</button>
    <button onclick="sairSala()" style="background:#555;margin-left:8px;">Sair</button>
  </div>

  <div style="position:relative;">
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <div class="hud" id="hud">Pontos: 0 | Vidas: 3</div>
    <div class="roomLabel" id="roomLabel">Sala: -</div>
  </div>

  <div class="controls">
    <div class="dpad">
      <div></div>
      <div class="btn" onclick="localMove('up')">‚ñ≤</div>
      <div></div>
      <div class="btn" onclick="localMove('left')">‚óÄ</div>
      <div></div>
      <div class="btn" onclick="localMove('right')">‚ñ∂</div>
      <div></div>
      <div class="btn" onclick="localMove('down')">‚ñº</div>
      <div></div>
    </div>

    <div class="actions">
      <div class="action-btn red" onclick="localShoot()">‚≠ï</div>
      <div class="action-btn blue" onclick="noop()">‚ùå</div>
      <div class="action-btn green" onclick="noop()">üî∫</div>
      <div class="action-btn yellow" onclick="noop()">üü•</div>
    </div>
  </div>

  <div class="footer">Pac-Battle Multiplayer ‚Äî conectado via Firebase Realtime DB</div>

<script>
// ---------------------- Firebase ----------------------
const firebaseConfig = {
  apiKey: "AIzaSyBJS1ilaSPaRe1m3NUE9blpa7MGiRchvvo",
  authDomain: "youfriends2025.firebaseapp.com",
  databaseURL: "https://youfriends2025-default-rtdb.firebaseio.com",
  projectId: "youfriends2025",
  storageBucket: "youfriends2025.firebasestorage.app",
  messagingSenderId: "1025903866437",
  appId: "1:1025903866437:web:49401c0e8edf59dd63292c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------------- Estado local ----------------------
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let clientId = 'c_' + Math.random().toString(36).slice(2,9);
let salaAtual = "";
let connected = false;

let pacman = { x: 60, y: 60, size: 12, dir: 'right', speed: 15, color: 'yellow', lives: 3, score: 0 };
let otherPlayers = {};
let bullets = [];
let remoteBullets = {};

// Labirinto
let barriers = [
  {x:0, y:0, width:400, height:8},
  {x:0, y:0, width:8, height:400},
  {x:0, y:392, width:400, height:8},
  {x:392, y:0, width:8, height:400},
  {x:80, y:80, width:240, height:8},
  {x:80, y:80, width:8, height:140},
  {x:80, y:200, width:120, height:8},
  {x:200, y:80, width:8, height:140},
  {x:200, y:200, width:120, height:8},
  {x:320, y:80, width:8, height:140},
  {x:120, y:260, width:160, height:8},
  {x:120, y:260, width:8, height:100},
  {x:280, y:260, width:8, height:100},
  {x:120, y:360, width:160, height:8}
];

// ---------------------- Respawn ----------------------
function respawnPlayer(){
  pacman.x = 60;
  pacman.y = 60;
  pacman.lives = 3; // volta com vidas cheias
  writePlayerToDB();
}

// ---------------------- Fun√ß√µes desenho ----------------------
function drawBarriers(){ ctx.fillStyle="#b22222"; barriers.forEach(b=>ctx.fillRect(b.x,b.y,b.width,b.height)); }
function drawPac(x,y,size,dir,color){
  let startAngle,endAngle;
  switch(dir){
    case 'right': startAngle=0.25*Math.PI; endAngle=1.75*Math.PI; break;
    case 'left': startAngle=1.25*Math.PI; endAngle=2.75*Math.PI; break;
    case 'up': startAngle=1.75*Math.PI; endAngle=1.25*Math.PI; break;
    case 'down': startAngle=0.75*Math.PI; endAngle=0.25*Math.PI; break;
    default: startAngle=0.25*Math.PI; endAngle=1.75*Math.PI;
  }
  ctx.fillStyle=color||"yellow";
  ctx.beginPath();
  ctx.arc(x,y,size,startAngle,endAngle,false);
  ctx.lineTo(x,y);
  ctx.fill();
}
function drawPlayers(){
  for(let id in otherPlayers){
    const p=otherPlayers[id];
    if(!p) continue;
    drawPac(p.x,p.y,p.size||10,p.dir||'left',p.color||'#ffccff');
    ctx.fillStyle="#fff"; ctx.font="10px Arial";
    ctx.fillText(id===clientId?"(Voc√™)":id.slice(0,4), p.x-12, p.y-(p.size||10)-6);
  }
  drawPac(pacman.x,pacman.y,pacman.size,pacman.dir,pacman.color);
}
function drawBullets(){
  for(let id in remoteBullets){
    let b=remoteBullets[id];
    if(!b) continue;
    ctx.fillStyle=b.owner===clientId?"cyan":"white";
    ctx.beginPath(); ctx.arc(b.x,b.y,4,0,2*Math.PI); ctx.fill();
  }
  bullets.forEach(b=>{
    ctx.fillStyle="cyan";
    ctx.beginPath(); ctx.arc(b.x,b.y,4,0,2*Math.PI); ctx.fill();
  });
}

// ---------------------- Colis√µes ----------------------
function checkCollision(newX,newY,size=pacman.size){
  for(let b of barriers){
    if(newX+size>b.x && newX-size<b.x+b.width && newY+size>b.y && newY-size<b.y+b.height) return true;
  }
  return false;
}
function pointInCircle(px,py,cx,cy,r){ return (px-cx)*(px-cx)+(py-cy)*(py-cy)<=r*r; }

// ---------------------- DB ----------------------
function writePlayerToDB(){
  if(!salaAtual) return;
  const ref=db.ref(`games/${salaAtual}/players/${clientId}`);
  ref.set({x:Math.round(pacman.x), y:Math.round(pacman.y), dir:pacman.dir, color:pacman.color, lives:pacman.lives, score:pacman.score, ts:Date.now()});
  db.ref(`games/${salaAtual}/players/${clientId}`).onDisconnect().remove();
}
function removePlayerFromDB(){ if(salaAtual) db.ref(`games/${salaAtual}/players/${clientId}`).remove(); }
function pushBulletToDB(b){
  if(!salaAtual) return;
  const newRef=db.ref(`games/${salaAtual}/bullets`).push();
  b.created=Date.now(); newRef.set(b);
  setTimeout(()=>newRef.remove().catch(()=>{}),6000);
}
function removeBulletFromDB(bid){ if(salaAtual&&bid) db.ref(`games/${salaAtual}/bullets/${bid}`).remove().catch(()=>{}); }

// ---------------------- Movimento / tiros ----------------------
function localMove(direction){
  pacman.dir=direction;
  let nx=pacman.x, ny=pacman.y;
  if(direction==='up') ny-=pacman.speed;
  if(direction==='down') ny+=pacman.speed;
  if(direction==='left') nx-=pacman.speed;
  if(direction==='right') nx+=pacman.speed;
  if(!checkCollision(nx,ny)){ pacman.x=nx; pacman.y=ny; }
  writePlayerToDB();
}
function localShoot(){
  let offsetX=0, offsetY=0;
  switch(pacman.dir){ case 'right': offsetX=pacman.size+4; break; case 'left': offsetX=-(pacman.size+4); break; case 'up': offsetY=-(pacman.size+4); break; case 'down': offsetY=pacman.size+4; break; }
  const bid='b_'+Math.random().toString(36).slice(2,9);
  const b={id:bid, owner:clientId, x:pacman.x+offsetX, y:pacman.y+offsetY, dir:pacman.dir, speed:6, created:Date.now()};
  bullets.push(b); pushBulletToDB(b);
}
function noop(){}

// ---------------------- DB listeners ----------------------
function startDBListeners(){
  if(!salaAtual) return;
  db.ref(`games/${salaAtual}/players`).on('value',snap=>{
    const obj=snap.val()||{}; otherPlayers={};
    for(let id in obj){ if(id!==clientId) otherPlayers[id]=obj[id]; }
  });
  db.ref(`games/${salaAtual}/bullets`).on('value',snap=>{
    const obj=snap.val()||{}; remoteBullets={};
    for(let id in obj){ const b=obj[id]; if(b&&b.id) remoteBullets[b.id]={...b}; }
  });
}
function stopDBListeners(){ if(salaAtual){ db.ref(`games/${salaAtual}/players`).off('value'); db.ref(`games/${salaAtual}/bullets`).off('value'); } }

// ---------------------- Sala ----------------------
function criarSala(){ const codigo=Math.floor(1000+Math.random()*9000).toString(); db.ref(`games/${codigo}`).set({created:Date.now()},()=>{document.getElementById('codigoSala').value=codigo; entrarSala();}); }
function entrarSala(){
  const codigo=document.getElementById('codigoSala').value.trim();
  if(codigo.length!==4) return alert('C√≥digo inv√°lido (4 d√≠gitos).');
  salaAtual=codigo; document.getElementById('roomLabel').innerText='Sala: '+salaAtual;
  writePlayerToDB(); startDBListeners(); connected=true;
  db.ref(`games/${salaAtual}/players/${clientId}`).onDisconnect().remove();
}
function sairSala(){
  if(!salaAtual) return;
  stopDBListeners(); removePlayerFromDB();
  db.ref(`games/${salaAtual}/bullets`).once('value',snap=>{
    const obj=snap.val()||{}; for(let id in obj){ if(obj[id].owner===clientId) db.ref(`games/${salaAtual}/bullets/${id}`).remove().catch(()=>{}); }
  }).finally(()=>{ salaAtual=""; otherPlayers={}; remoteBullets={}; bullets=[]; document.getElementById('roomLabel').innerText='Sala: -'; connected=false; });
}

// ---------------------- L√≥gica balas ----------------------
function stepBullets(delta){
  for(let i=bullets.length-1;i>=0;i--){
    let b=bullets[i];
    if(b.dir==='up') b.y-=b.speed;
    if(b.dir==='down') b.y+=b.speed;
    if(b.dir==='left') b.x-=b.speed;
    if(b.dir==='right') b.x+=b.speed;
    if(checkCollision(b.x,b.y) || b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height){ removeBulletFromDB(b.id); bullets.splice(i,1); continue; }
    for(let pid in otherPlayers){
      const p=otherPlayers[pid];
      if(pointInCircle(b.x,b.y,p.x,p.y,(p.size||10))){
        const targetRef=db.ref(`games/${salaAtual}/players/${pid}`);
        targetRef.once('value').then(snap=>{
          const data=snap.val(); if(!data) return;
          let newLives=(data.lives||3)-1;
          if(newLives<=0){ db.ref(`games/${salaAtual}/players/${pid}`).update({ lives:0 }); }
          else { db.ref(`games/${salaAtual}/players/${pid}`).update({ lives:newLives }); }
        });
        removeBulletFromDB(b.id); bullets.splice(i,1); break;
      }
    }
  }
  for(let id in remoteBullets){
    const b=remoteBullets[id]; if(!b) continue;
    switch(b.dir){case 'up':b.y-=b.speed;break;case 'down':b.y+=b.speed;break;case 'left':b.x-=b.speed;break;case 'right':b.x+=b.speed;break;}
    if(checkCollision(b.x,b.y)||b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height){ removeBulletFromDB(b.id); delete remoteBullets[id]; continue; }
    if(b.owner!==clientId && pointInCircle(b.x,b.y,pacman.x,pacman.y,pacman.size)){
      pacman.lives-=1;
      db.ref(`games/${salaAtual}/players/${clientId}`).update({ lives:pacman.lives }).catch(()=>{});
      removeBulletFromDB(b.id); delete remoteBullets[id];
      if(pacman.lives<=0){
        alert('Voc√™ foi derrotado! Respawn em 3 segundos...');
        setTimeout(()=>{ respawnPlayer(); },3000);
      }
    }
  }
}

// ---------------------- Loop ----------------------
let lastTime=Date.now();
function update(){
  const now=Date.now(); const delta=now-lastTime; lastTime=now;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBarriers(); drawPlayers(); drawBullets(); stepBullets(delta);
  document.getElementById('hud').innerText=`Pontos: ${pacman.score} | Vidas: ${pacman.lives}`;
  requestAnimationFrame(update);
}
update();

document.addEventListener('keydown',e=>{ if(e.key==='ArrowUp')localMove('up'); if(e.key==='ArrowDown')localMove('down'); if(e.key==='ArrowLeft')localMove('left'); if(e.key==='ArrowRight')localMove('right'); if(e.key===' ')localShoot(); });
window.addEventListener('beforeunload',()=>{ if(salaAtual) removePlayerFromDB(); });
</script>
</body>
      </html>
